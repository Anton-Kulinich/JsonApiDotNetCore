<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Resource Definitions </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Resource Definitions ">
    <meta name="generator" content="docfx 2.56.2.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="resource-definitions">Resource Definitions</h1>

<p>In order to improve the developer experience, we have introduced a type that makes
common modifications to the default API behavior easier. Resource definitions were first introduced in v2.3.4.</p>
<p>Resource definitions are resolved from the dependency injection container, so you can inject dependencies in their constructor.</p>
<h2 id="customizing-query-clauses">Customizing query clauses</h2>
<p><em>since v4.0</em></p>
<p>For various reasons (see examples below) you may need to change parts of the query, depending on resource type.
<code>JsonApiResourceDefinition&lt;TResource&gt;</code> (which is an empty implementation of <code>IResourceDefinition&lt;TResource&gt;</code>) provides overridable methods that pass you the result of query string parameter parsing.
The value returned by you determines what will be used to execute the query.</p>
<p>An intermediate format (<code>QueryExpression</code> and derived types) is used, which enables us to separate json:api implementation 
from Entity Framework Core <code>IQueryable</code> execution.</p>
<h3 id="excluding-fields">Excluding fields</h3>
<p>There are some cases where you want attributes conditionally excluded from your resource response.
For example, you may accept some sensitive data that should only be exposed to administrators after creation.</p>
<p>Note: to exclude attributes unconditionally, use <code>[Attr(Capabilities = ~AttrCapabilities.AllowView)]</code>.</p>
<pre><code class="lang-c#">public class UserDefinition : JsonApiResourceDefinition&lt;User&gt;
{
    public UserDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override SparseFieldSetExpression OnApplySparseFieldSet(
        SparseFieldSetExpression existingSparseFieldSet)
    {
        if (IsAdministrator)
        {
            return existingSparseFieldSet;
        }

        return existingSparseFieldSet.Excluding&lt;User&gt;(
            user =&gt; user.Password, ResourceGraph);
    }
}
</code></pre><p>Using this technique, you can achieve the following request/response behavior:</p>
<pre><code class="lang-http">POST /users HTTP/1.1
Content-Type: application/vnd.api+json

{
  &quot;data&quot;: {
    &quot;type&quot;: &quot;users&quot;,
    &quot;attributes&quot;: {
      &quot;password&quot;: &quot;secret&quot;,
      &quot;name&quot;: &quot;John Doe&quot;
    }
  }
}
</code></pre><pre><code class="lang-http">HTTP/1.1 201 Created
Location: http://example.com/users/1
Content-Type: application/vnd.api+json

{
  &quot;data&quot;: {
    &quot;type&quot;: &quot;users&quot;,
    &quot;id&quot;: &quot;1&quot;,
    &quot;attributes&quot;: {
      &quot;name&quot;: &quot;John Doe&quot;
    }
  }
}
</code></pre><h2 id="default-sort-order">Default sort order</h2>
<p>You can define the default sort order if no <code>sort</code> query string parameter is provided.</p>
<pre><code class="lang-c#">public class AccountDefinition : JsonApiResourceDefinition&lt;Account&gt;
{
    public AccountDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override SortExpression OnApplySort(SortExpression existingSort)
    {
        if (existingSort != null)
        {
            return existingSort;
        }

        return CreateSortExpressionFromLambda(new PropertySortOrder
        {
            (account =&gt; account.Name, ListSortDirection.Ascending),
            (account =&gt; account.ModifiedAt, ListSortDirection.Descending)
        });
    }
}
</code></pre><h2 id="enforce-page-size">Enforce page size</h2>
<p>You may want to enforce pagination on large database tables.</p>
<pre><code class="lang-c#">public class AccessLogDefinition : JsonApiResourceDefinition&lt;AccessLog&gt;
{
    public AccessLogDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override PaginationExpression OnApplyPagination(
        PaginationExpression existingPagination)
    {
        var maxPageSize = new PageSize(10);

        if (existingPagination != null)
        {
            var pageSize = existingPagination.PageSize?.Value &lt;= maxPageSize.Value
                ? existingPagination.PageSize
                : maxPageSize;

            return new PaginationExpression(existingPagination.PageNumber, pageSize);
        }

        return new PaginationExpression(PageNumber.ValueOne, maxPageSize);
    }
}
</code></pre><h2 id="exclude-soft-deleted-resources">Exclude soft-deleted resources</h2>
<p>Soft-deletion sets <code>IsSoftDeleted</code> to <code>true</code> instead of actually deleting the record, so you may want to always filter them out.</p>
<pre><code class="lang-c#">public class AccountDefinition : JsonApiResourceDefinition&lt;Account&gt;
{
    public AccountDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override FilterExpression OnApplyFilter(FilterExpression existingFilter)
    {
        var resourceContext = ResourceGraph.GetResourceContext&lt;Account&gt;();

        var isSoftDeletedAttribute =
            resourceContext.Attributes.Single(a =&gt;
                a.Property.Name == nameof(Account.IsSoftDeleted));

        var isNotSoftDeleted = new ComparisonExpression(ComparisonOperator.Equals,
            new ResourceFieldChainExpression(isSoftDeletedAttribute),
            new LiteralConstantExpression(bool.FalseString));

        return existingFilter == null
            ? (FilterExpression) isNotSoftDeleted
            : new LogicalExpression(LogicalOperator.And,
                new[] {isNotSoftDeleted, existingFilter});
    }
}
</code></pre><h2 id="block-including-related-resources">Block including related resources</h2>
<pre><code class="lang-c#">public class EmployeeDefinition : JsonApiResourceDefinition&lt;Employee&gt;
{
    public EmployeeDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override IReadOnlyCollection&lt;IncludeElementExpression&gt; OnApplyIncludes(
        IReadOnlyCollection&lt;IncludeElementExpression&gt; existingIncludes)
    {
        if (existingIncludes.Any(include =&gt;
            include.Relationship.Property.Name == nameof(Employee.Manager)))
        {
            throw new JsonApiException(new Error(HttpStatusCode.BadRequest)
            {
                Title = &quot;Including the manager of employees is not permitted.&quot;
            });
        }

        return existingIncludes;
    }
}
</code></pre><h2 id="custom-query-string-parameters">Custom query string parameters</h2>
<p><em>since v3.0.0</em></p>
<p>You can define additional query string parameters with the LINQ expression that should be used.
If the key is present in a query string, the supplied LINQ expression will be added to the database query.</p>
<p>Note this directly influences the Entity Framework Core <code>IQueryable</code>. As opposed to using <code>OnApplyFilter</code>, this enables the full range of EF Core functionality. 
But it only works on primary resource endpoints (for example: /articles, but not on /blogs/1/articles or /blogs?include=articles).</p>
<pre><code class="lang-c#">public class ItemDefinition : JsonApiResourceDefinition&lt;Item&gt;
{
    public ItemDefinition(IResourceGraph resourceGraph) : base(resourceGraph)
    {
    }

    public override QueryStringParameterHandlers&lt;Item&gt;
        OnRegisterQueryableHandlersForQueryStringParameters()
    {
        return new QueryStringParameterHandlers&lt;Item&gt;
        {
            [&quot;isActive&quot;] = (source, parameterValue) =&gt; source
                .Include(item =&gt; item.Children)
                .Where(item =&gt; item.LastUpdateTime &gt; DateTime.Now.AddMonths(-1)),
            [&quot;isHighRisk&quot;] = FilterByHighRisk
        };
    }

    private static IQueryable&lt;Item&gt; FilterByHighRisk(IQueryable&lt;Item&gt; source,
        StringValues parameterValue)
    {
        bool isFilterOnHighRisk = bool.Parse(parameterValue);

        return isFilterOnHighRisk
            ? source.Where(item =&gt; item.RiskLevel &gt;= 5)
            : source.Where(item =&gt; item.RiskLevel &lt; 5);
    }
}
</code></pre><h2 id="using-resource-definitions-prior-to-v3">Using Resource Definitions prior to v3</h2>
<p>Prior to the introduction of auto-discovery, you needed to register the
<code>ResourceDefinition</code> on the container yourself:</p>
<pre><code class="lang-c#">services.AddScoped&lt;ResourceDefinition&lt;Item&gt;, ItemResource&gt;();
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/json-api-dotnet/JsonApiDotNetCore/blob/master/docs/usage/resources/resource-definitions.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
